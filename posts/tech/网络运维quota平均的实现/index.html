<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>网络运维—Quota平均的实现 | GopherDing&#39;s Blog</title>
<meta name="keywords" content="">
<meta name="description" content="如何实现Quota平均">
<meta name="author" content="GopherDing">
<link rel="canonical" href="https://gopherding.github.io/posts/tech/%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4quota%E5%B9%B3%E5%9D%87%E7%9A%84%E5%AE%9E%E7%8E%B0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.css" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.js" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://gopherding.github.io/img/GopherSpaceCommunity.png">
<link rel="icon" type="image/png" sizes="16x16" href="https://gopherding.github.io/img/GopherSpaceCommunity.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://gopherding.github.io/img/GopherSpaceCommunity.png">
<link rel="apple-touch-icon" href="https://gopherding.github.io/img/GopherSpaceCommunity.png">
<link rel="mask-icon" href="https://gopherding.github.io/img/GopherSpaceCommunity.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="https://gopherding.github.io/posts/tech/%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4quota%E5%B9%B3%E5%9D%87%E7%9A%84%E5%AE%9E%E7%8E%B0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.7.2/css/all.css">

<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.7.1/jquery.min.js"></script>


<script>// 移动端导航优化脚本
(function() {
    'use strict';
    
    function optimizeNavigation() {
        const menu = document.getElementById('menu');
        if (!menu) return;
        
        const menuItems = menu.querySelectorAll('li a span');
        
        // 移除导航文字隐藏功能，保持所有设备都显示完整文本
        menuItems.forEach(item => {
            const originalText = item.textContent || item.innerText;
            
            if (!item.dataset.originalText) {
                item.dataset.originalText = originalText;
            }
            
            // 始终显示完整文本，不再隐藏
            item.textContent = item.dataset.originalText || originalText;
            item.closest('a').removeAttribute('title');
        });
    }
    
    // 窗口大小改变时重新优化
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(optimizeNavigation, 150);
    });
    
    // 添加触摸反馈
    function addTouchFeedback() {
        const menuItems = document.querySelectorAll('#menu li a');
        
        menuItems.forEach(item => {
            // 触摸开始时添加按下效果
            item.addEventListener('touchstart', function(e) {
                this.style.transform = 'scale(0.95)';
                this.style.transition = 'transform 0.1s ease';
            });
            
            // 触摸结束时恢复
            item.addEventListener('touchend', function(e) {
                setTimeout(() => {
                    this.style.transform = '';
                    this.style.transition = '';
                }, 100);
            });
        });
    }
    
    // 页面加载完成后添加触摸反馈
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            optimizeNavigation();
            addTouchFeedback();
        });
    } else {
        optimizeNavigation();
        addTouchFeedback();
    }
    
})();</script>


<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = ""; 
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<meta property="og:title" content="网络运维—Quota平均的实现" />
<meta property="og:description" content="如何实现Quota平均" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gopherding.github.io/posts/tech/%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4quota%E5%B9%B3%E5%9D%87%E7%9A%84%E5%AE%9E%E7%8E%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-06T15:55:23+08:00" />
<meta property="article:modified_time" content="2024-09-06T15:55:23+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="网络运维—Quota平均的实现"/>
<meta name="twitter:description" content="如何实现Quota平均"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [

        {
          "@type": "ListItem",
          "position":  1 ,
          "name": "📚文章",
          "item": "https://gopherding.github.io/posts/"
        },

        {
          "@type": "ListItem",
          "position":  2 ,
          "name": "👨🏻‍💻 技术",
          "item": "https://gopherding.github.io/posts/tech/"
        }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "网络运维—Quota平均的实现",
      "item": "https://gopherding.github.io/posts/tech/%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4quota%E5%B9%B3%E5%9D%87%E7%9A%84%E5%AE%9E%E7%8E%B0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "网络运维—Quota平均的实现",
  "name": "网络运维—Quota平均的实现",
  "description": "如何实现Quota平均",
  "keywords": [
    ""
  ],
  "articleBody": "交换机层面 在交换机层面实现网络带宽 quota 平均，主要可通过以下几种方式：\n基于端口的带宽限制 原理：利用交换机的端口限速功能，为每个端口设定固定的带宽上限。可以基于物理端口进行设置，也可以针对端口下的不同 VLAN 进行设置。 实现方式：在交换机的配置界面中，进入相应端口或 VLAN 的配置模式，使用命令设置带宽限制值。例如，在 Cisco 交换机中，可使用 “interface FastEthernet0/1” 进入端口 1 的配置模式，然后通过 “speed 100” 和 “duplex full” 设置端口速率和双工模式，再使用 “traffic-shape rate 10000000” 命令将该端口的带宽限制为 10Mbps。 基于队列的调度算法 原理：将端口的流量划分为多个队列，每个队列对应不同类型的业务或用户。交换机根据预设的调度算法，如加权轮询（WRR）、严格优先级（SP）等，在各个队列之间分配带宽。 实现方式：以华为交换机为例，首先创建队列并绑定到端口，如 “interface GigabitEthernet0/0/1” 进入端口配置，然后 “queue-scheduler wrr 10 20 30 40” 配置 WRR 调度算法，为四个队列分别分配 10%、20%、30%、40% 的带宽权重。若采用 SP 算法，可设置 “queue-scheduler sp”，并为不同队列配置优先级，高优先级队列优先获得带宽。 基于流量分类的带宽分配 原理：通过访问控制列表（ACL）或 MAC 地址表等对流量进行分类，识别出不同来源、目的或协议类型的流量，然后为不同类别的流量分配相应的带宽 quota。 实现方式：在 H3C 交换机上，先定义 ACL 规则来匹配流量，如 “acl number 2000” 创建 ACL 2000，然后 “rule 0 permit source 192.168.1.0 0.0.0.255” 允许源 IP 为 192.168.1.0/24 网段的流量通过。接着创建 QoS 策略，将 ACL 与带宽分配关联起来，“qos policy policy1” 创建 QoS 策略，“classifier c1 operator or acl 2000” 将 ACL 2000 与分类器关联，“behavior b1 bandwidth committed-rate 20480” 为匹配的流量分配 20Mbps 的带宽。 基于端口镜像的流量监测与控制 原理：将交换机某个端口或 VLAN 的流量复制一份到监控端口，通过连接到监控端口的流量监测设备，实时监测流量情况。根据监测结果，对异常流量或超出 quota 的流量进行控制。 实现方式：在锐捷交换机中，使用 “monitor session 1 source interface GigabitEthernet 0/1” 命令将端口 1 的流量作为源流量进行镜像，再使用 “monitor session 1 destination interface GigabitEthernet 0/2” 将镜像流量发送到端口 2。通过连接到端口 2 的流量监测设备，如网络分析仪，实时查看流量数据。若发现某个 IP 地址的流量超出 quota，可在交换机上通过配置 ACL 或 QoS 策略，对该 IP 的流量进行限制。 基于流控的带宽管理 原理：当交换机检测到某个端口或链路的流量即将超出带宽 quota 时，通过发送流控帧等方式，通知上游设备降低发送速率，以避免网络拥塞，实现带宽的平均分配。 实现方式：在多数交换机中，流控功能默认是关闭的，需要手动开启。如在戴尔交换机中，进入全局配置模式 “configure terminal”，然后进入端口配置模式 “interface Ethernet1/0/1”，使用 “flowcontrol receive on” 命令开启端口的接收流控功能，“flowcontrol transmit on” 开启发送流控功能。交换机将根据端口的带宽使用情况，自动发送或接收流控帧，调节流量。 OpenWrt实现 在 OpenWRT 系统中，可以通过多种方式实现网络带宽 quota 平均，以下是一些常见的方法：\n使用 LuCI 界面配置 安装 LuCI：OpenWRT 默认可能没有安装 LuCI 图形界面，需要通过命令行安装。连接到 OpenWRT 设备的命令行界面，使用包管理工具 opkg 进行安装，如opkg update \u0026\u0026 opkg install luci。 配置 QoS：安装完成后，在浏览器中输入 OpenWRT 设备的 IP 地址，进入 LuCI 界面。在 LuCI 界面中找到 “网络” 选项卡，点击 “QoS”。在这里可以创建 QoS 规则，通过 “添加规则” 按钮，选择要设置带宽限制的接口，如 LAN 口。在 “目标” 字段中，可以选择 “网络中的主机”，然后输入要限制带宽的设备 IP 地址。在 “带宽限制” 部分，设置上传和下载带宽的具体数值，以实现对特定设备的带宽 quota 平均分配。 设置调度算法：在 QoS 设置页面，通常可以选择调度算法，如令牌桶算法等。令牌桶算法可以通过控制令牌的生成速率和桶的容量来限制流量速率，确保带宽的合理分配。选择合适的算法后，根据实际需求配置相关参数，如令牌生成速率、桶容量等。 使用 SQM 插件 安装 SQM：SQM（Simple Queue Management）是 OpenWRT 中常用的带宽管理插件。通过命令行安装，opkg install sqm-scripts。 配置 SQM：安装完成后，编辑 SQM 配置文件，通常位于/etc/config/sqm。在配置文件中，定义要管理的接口和带宽限制参数。例如，以下配置将对 eth0 接口进行带宽管理，下载带宽限制为 20Mbps，上传带宽限制为 10Mbps。 config queue option interface 'eth0' option download '20mbit' option upload '10mbit' 保存配置文件后，重启 SQM 服务使配置生效，/etc/init.d/sqm restart。\n",
  "wordCount" : "1985",
  "inLanguage": "zh",
  "datePublished": "2024-09-06T15:55:23+08:00",
  "dateModified": "2024-09-06T15:55:23+08:00",
  "author":[{
    "@type": "Person",
    "name": "GopherDing"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://gopherding.github.io/posts/tech/%E7%BD%91%E7%BB%9C%E8%BF%90%E7%BB%B4quota%E5%B9%B3%E5%9D%87%E7%9A%84%E5%AE%9E%E7%8E%B0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "GopherDing's Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://gopherding.github.io/img/GopherSpaceCommunity.png"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    (function () {
        let  arr,reg = new RegExp("(^| )"+"change-themes"+"=([^;]*)(;|$)");
        if(arr = document.cookie.match(reg)) {
        } else {
            if (new Date().getHours() >= 19 || new Date().getHours() < 6) {
                document.body.classList.add('dark');
                localStorage.setItem("pref-theme", 'dark');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem("pref-theme", 'light');
            }
        }
    })()

    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }
</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://gopherding.github.io/" accesskey="h" title="GopherDing&#39;s Blog (Alt + H)">
            <img src="https://gopherding.github.io/img/GopherSpaceCommunity.png" alt="logo" aria-label="logo"
                 height="50">GopherDing&#39;s Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                         fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                         stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://gopherding.github.io/" title="🏠 主页">
                <span>🏠 主页</span>
                </a>
            </li>
            <li>
                <a href="https://gopherding.github.io/search" title="🔍 搜索 (Alt &#43; /)" accesskey=/>
                <span>🔍 搜索</span>
                </a>
            </li>
            <li>
                <a href="https://gopherding.github.io/tags" title="🧩 标签">
                <span>🧩 标签</span>
                </a>
            </li>
            <li>
                <a href="https://gopherding.github.io/archives/" title="⏱️ 时间轴">
                <span>⏱️ 时间轴</span>
                </a>
            </li>
            <li>
                <a href="https://gopherding.github.io/about" title="🙋🏻‍♂️ 关于">
                <span>🙋🏻‍♂️ 关于</span>
                </a>
            </li>
            <li>
                <a href="https://gopherding.github.io/links" title="🤝 友链">
                <span>🤝 友链</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main page">
<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }
</style>

<article class="post-single">
    <div id="single-content">
        <header class="post-header">
            <div class="breadcrumbs"><a href="https://gopherding.github.io/">🏠 主页</a>&nbsp;»&nbsp;<a href="https://gopherding.github.io/posts/">📚文章</a>&nbsp;»&nbsp;<a href="https://gopherding.github.io/posts/tech/">👨🏻‍💻 技术</a></div>
            <h1 class="post-title">
                网络运维—Quota平均的实现
            </h1>
            <div class="post-description">
                如何实现Quota平均
            </div>
            <div class="post-meta">

<style>
    i[id*="post_meta_style"] {
        display: flex;
        align-items: center;
        margin: 0 0 10px 0;
    }

    .parent-post-meta {
        display: flex;
        flex-wrap: wrap;
        opacity: 0.8;
    }
</style>

<span class="parent-post-meta">
    <span id="post_meta_style_1">
        <span class="fa fa-calendar-check-o"></span>
        <span>2024-09-06
            &nbsp;&nbsp;
        </span>
    </span>
    
    
    
    
    
    
    
    <span id="post_meta_style_3">
        <span class="fa fa-file-word-o"></span>
        <span>1985字
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_4">
        <span class="fa fa-clock-o"></span>
        <span>4分钟
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_5">
        <span class="fa fa-user-o"></span>
        <span>GopherDing
            &nbsp;&nbsp;
        </span>
    </span>
    <span id="post_meta_style_6">
        <span class="fa fa-tags" style="opacity: 0.8"></span>
        <span>
            <span class="post-tags-meta">
                <a href="https://gopherding.github.io/tags/%E8%BF%90%E7%BB%B4/" style="color: var(--secondary)!important;">运维</a>
            </span>
        </span>
    </span>
</span>
<span style="opacity: 0.8;">
                    <span id="post_meta_style_7">
                        &nbsp;&nbsp;
                        <span class="fa fa-eye" ></span>
                        <span>
                            <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
                            &nbsp;&nbsp;
                        </span>
                    </span>
                    <span id="post_meta_style_8">
                        <span class="fa fa-commenting-o"></span>
                        <span>
                            <script src="https://cdn.staticfile.org/twikoo//twikoo.all.min.js"></script>
                            <script>
                                let url = document.documentURI
                                
                                let dnsUrl = "https://gopherding.github.io/"
                                let urlSplit = url.split(dnsUrl)
                                let finalUrl = urlSplit[1]
                                if (finalUrl[0] !== '/') {
                                    finalUrl = '/'+finalUrl
                                }
                                twikoo.getCommentsCount({
                                    envId:  null , 
                                region:  null , 
                                urls: [ 
                                    
                                    finalUrl,
                                ],
                                    includeReply: false 
                                }).then(function (res) {
                                    let count = res[0].count
                                    const obj = document.getElementById("comment_count");
                                    obj.innerText = count
                                    
                                    
                                    
                                }).catch(function (err) {
                                    
                                    console.error(err);
                                });
                            </script>
                            <span id="comment_count"></span>
                        </span>
                    </span>
                </span>

</div>
        </header> <aside id="toc-container" class="toc-container wide">
    <div class="toc">
        <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%ba%a4%e6%8d%a2%e6%9c%ba%e5%b1%82%e9%9d%a2" aria-label="交换机层面">交换机层面</a><ul>
                        
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e7%ab%af%e5%8f%a3%e7%9a%84%e5%b8%a6%e5%ae%bd%e9%99%90%e5%88%b6" aria-label="基于端口的带宽限制">基于端口的带宽限制</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e9%98%9f%e5%88%97%e7%9a%84%e8%b0%83%e5%ba%a6%e7%ae%97%e6%b3%95" aria-label="基于队列的调度算法">基于队列的调度算法</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e6%b5%81%e9%87%8f%e5%88%86%e7%b1%bb%e7%9a%84%e5%b8%a6%e5%ae%bd%e5%88%86%e9%85%8d" aria-label="基于流量分类的带宽分配">基于流量分类的带宽分配</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e7%ab%af%e5%8f%a3%e9%95%9c%e5%83%8f%e7%9a%84%e6%b5%81%e9%87%8f%e7%9b%91%e6%b5%8b%e4%b8%8e%e6%8e%a7%e5%88%b6" aria-label="基于端口镜像的流量监测与控制">基于端口镜像的流量监测与控制</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8e%e6%b5%81%e6%8e%a7%e7%9a%84%e5%b8%a6%e5%ae%bd%e7%ae%a1%e7%90%86" aria-label="基于流控的带宽管理">基于流控的带宽管理</a></li></ul>
                </li>
                <li>
                    <a href="#openwrt%e5%ae%9e%e7%8e%b0" aria-label="OpenWrt实现">OpenWrt实现</a><ul>
                        
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-luci-%e7%95%8c%e9%9d%a2%e9%85%8d%e7%bd%ae" aria-label="使用 LuCI 界面配置">使用 LuCI 界面配置</a></li>
                <li>
                    <a href="#%e4%bd%bf%e7%94%a8-sqm-%e6%8f%92%e4%bb%b6" aria-label="使用 SQM 插件">使用 SQM 插件</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
        </details>
    </div>
</aside>
<script>
    let activeElement;
    let elements;
    window.addEventListener('DOMContentLoaded', function (event) {
        checkTocPosition();

        elements = document.querySelectorAll('h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]');
        
        activeElement = elements[0];
        const id = encodeURI(activeElement.getAttribute('id')).toLowerCase();
        document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
    }, false);

    window.addEventListener('resize', function(event) {
        checkTocPosition();
    }, false);

    window.addEventListener('scroll', () => {
        
        if (elements) {
            activeElement = Array.from(elements).find((element) => {
                if ((getOffsetTop(element) - window.pageYOffset) > 0 &&
                    (getOffsetTop(element) - window.pageYOffset) < window.innerHeight/2) {
                    return element;
                }
            }) || activeElement

            elements.forEach(element => {
                const id = encodeURI(element.getAttribute('id')).toLowerCase();
                if (element === activeElement){
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.add('active');
                } else {
                    document.querySelector(`.inner ul li a[href="#${id}"]`).classList.remove('active');
                }
            })
        }
    }, false);

    const main = parseInt(getComputedStyle(document.body).getPropertyValue('--article-width'), 10);
    const toc = parseInt(getComputedStyle(document.body).getPropertyValue('--toc-width'), 10);
    const gap = parseInt(getComputedStyle(document.body).getPropertyValue('--gap'), 10);

    function checkTocPosition() {
        const width = document.body.scrollWidth;
        if (width - main - (toc * 2) - (gap * 4) > 0) {
            document.getElementById("toc-container").classList.add("wide");
        } else {
            document.getElementById("toc-container").classList.remove("wide");
        }
    }

    function getOffsetTop(element) {
        if (!element.getClientRects().length) {
            return 0;
        }
        let rect = element.getBoundingClientRect();
        let win = element.ownerDocument.defaultView;
        return rect.top + win.pageYOffset;
    }
</script>
        <div class="post-content"><h3 id="交换机层面">交换机层面<a hidden class="anchor" aria-hidden="true" href="#交换机层面">#</a></h3>
<p>在交换机层面实现网络带宽 quota 平均，主要可通过以下几种方式：</p>
<h4 id="基于端口的带宽限制">基于端口的带宽限制<a hidden class="anchor" aria-hidden="true" href="#基于端口的带宽限制">#</a></h4>
<ul>
<li><strong>原理</strong>：利用交换机的端口限速功能，为每个端口设定固定的带宽上限。可以基于物理端口进行设置，也可以针对端口下的不同 VLAN 进行设置。</li>
<li><strong>实现方式</strong>：在交换机的配置界面中，进入相应端口或 VLAN 的配置模式，使用命令设置带宽限制值。例如，在 Cisco 交换机中，可使用 “interface FastEthernet0/1” 进入端口 1 的配置模式，然后通过 “speed 100” 和 “duplex full” 设置端口速率和双工模式，再使用 “traffic-shape rate 10000000” 命令将该端口的带宽限制为 10Mbps。</li>
</ul>
<h4 id="基于队列的调度算法">基于队列的调度算法<a hidden class="anchor" aria-hidden="true" href="#基于队列的调度算法">#</a></h4>
<ul>
<li><strong>原理</strong>：将端口的流量划分为多个队列，每个队列对应不同类型的业务或用户。交换机根据预设的调度算法，如加权轮询（WRR）、严格优先级（SP）等，在各个队列之间分配带宽。</li>
<li><strong>实现方式</strong>：以华为交换机为例，首先创建队列并绑定到端口，如 “interface GigabitEthernet0/0/1” 进入端口配置，然后 “queue-scheduler wrr 10 20 30 40” 配置 WRR 调度算法，为四个队列分别分配 10%、20%、30%、40% 的带宽权重。若采用 SP 算法，可设置 “queue-scheduler sp”，并为不同队列配置优先级，高优先级队列优先获得带宽。</li>
</ul>
<h4 id="基于流量分类的带宽分配">基于流量分类的带宽分配<a hidden class="anchor" aria-hidden="true" href="#基于流量分类的带宽分配">#</a></h4>
<ul>
<li><strong>原理</strong>：通过访问控制列表（ACL）或 MAC 地址表等对流量进行分类，识别出不同来源、目的或协议类型的流量，然后为不同类别的流量分配相应的带宽 quota。</li>
<li><strong>实现方式</strong>：在 H3C 交换机上，先定义 ACL 规则来匹配流量，如 “acl number 2000” 创建 ACL 2000，然后 “rule 0 permit source 192.168.1.0 0.0.0.255” 允许源 IP 为 192.168.1.0/24 网段的流量通过。接着创建 QoS 策略，将 ACL 与带宽分配关联起来，“qos policy policy1” 创建 QoS 策略，“classifier c1 operator or acl 2000” 将 ACL 2000 与分类器关联，“behavior b1 bandwidth committed-rate 20480” 为匹配的流量分配 20Mbps 的带宽。</li>
</ul>
<h4 id="基于端口镜像的流量监测与控制">基于端口镜像的流量监测与控制<a hidden class="anchor" aria-hidden="true" href="#基于端口镜像的流量监测与控制">#</a></h4>
<ul>
<li><strong>原理</strong>：将交换机某个端口或 VLAN 的流量复制一份到监控端口，通过连接到监控端口的流量监测设备，实时监测流量情况。根据监测结果，对异常流量或超出 quota 的流量进行控制。</li>
<li><strong>实现方式</strong>：在锐捷交换机中，使用 “monitor session 1 source interface GigabitEthernet 0/1” 命令将端口 1 的流量作为源流量进行镜像，再使用 “monitor session 1 destination interface GigabitEthernet 0/2” 将镜像流量发送到端口 2。通过连接到端口 2 的流量监测设备，如网络分析仪，实时查看流量数据。若发现某个 IP 地址的流量超出 quota，可在交换机上通过配置 ACL 或 QoS 策略，对该 IP 的流量进行限制。</li>
</ul>
<h4 id="基于流控的带宽管理">基于流控的带宽管理<a hidden class="anchor" aria-hidden="true" href="#基于流控的带宽管理">#</a></h4>
<ul>
<li><strong>原理</strong>：当交换机检测到某个端口或链路的流量即将超出带宽 quota 时，通过发送流控帧等方式，通知上游设备降低发送速率，以避免网络拥塞，实现带宽的平均分配。</li>
<li><strong>实现方式</strong>：在多数交换机中，流控功能默认是关闭的，需要手动开启。如在戴尔交换机中，进入全局配置模式 “configure terminal”，然后进入端口配置模式 “interface Ethernet1/0/1”，使用 “flowcontrol receive on” 命令开启端口的接收流控功能，“flowcontrol transmit on” 开启发送流控功能。交换机将根据端口的带宽使用情况，自动发送或接收流控帧，调节流量。</li>
</ul>
<hr>
<h3 id="openwrt实现">OpenWrt实现<a hidden class="anchor" aria-hidden="true" href="#openwrt实现">#</a></h3>
<p>在 OpenWRT 系统中，可以通过多种方式实现网络带宽 quota 平均，以下是一些常见的方法：</p>
<h4 id="使用-luci-界面配置">使用 LuCI 界面配置<a hidden class="anchor" aria-hidden="true" href="#使用-luci-界面配置">#</a></h4>
<ul>
<li><strong>安装 LuCI</strong>：OpenWRT 默认可能没有安装 LuCI 图形界面，需要通过命令行安装。连接到 OpenWRT 设备的命令行界面，使用包管理工具 opkg 进行安装，如<code>opkg update &amp;&amp; opkg install luci</code>。</li>
<li><strong>配置 QoS</strong>：安装完成后，在浏览器中输入 OpenWRT 设备的 IP 地址，进入 LuCI 界面。在 LuCI 界面中找到 “网络” 选项卡，点击 “QoS”。在这里可以创建 QoS 规则，通过 “添加规则” 按钮，选择要设置带宽限制的接口，如 LAN 口。在 “目标” 字段中，可以选择 “网络中的主机”，然后输入要限制带宽的设备 IP 地址。在 “带宽限制” 部分，设置上传和下载带宽的具体数值，以实现对特定设备的带宽 quota 平均分配。</li>
<li><strong>设置调度算法</strong>：在 QoS 设置页面，通常可以选择调度算法，如令牌桶算法等。令牌桶算法可以通过控制令牌的生成速率和桶的容量来限制流量速率，确保带宽的合理分配。选择合适的算法后，根据实际需求配置相关参数，如令牌生成速率、桶容量等。</li>
</ul>
<h4 id="使用-sqm-插件">使用 SQM 插件<a hidden class="anchor" aria-hidden="true" href="#使用-sqm-插件">#</a></h4>
<ul>
<li><strong>安装 SQM</strong>：SQM（Simple Queue Management）是 OpenWRT 中常用的带宽管理插件。通过命令行安装，<code>opkg install sqm-scripts</code>。</li>
<li><strong>配置 SQM</strong>：安装完成后，编辑 SQM 配置文件，通常位于<code>/etc/config/sqm</code>。在配置文件中，定义要管理的接口和带宽限制参数。例如，以下配置将对 eth0 接口进行带宽管理，下载带宽限制为 20Mbps，上传带宽限制为 10Mbps。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-plaintext" data-lang="plaintext"><span style="display:flex;"><span>config queue
</span></span><span style="display:flex;"><span>        option interface &#39;eth0&#39;
</span></span><span style="display:flex;"><span>        option download &#39;20mbit&#39;
</span></span><span style="display:flex;"><span>        option upload &#39;10mbit&#39;
</span></span></code></pre></div><p>保存配置文件后，重启 SQM 服务使配置生效，<code>/etc/init.d/sqm restart</code>。</p>


        </div>

        <footer class="post-footer">
            
<nav class="paginav">
  <a class="prev" href="https://gopherding.github.io/posts/tech/elk%E5%92%8Cefk/">
    <span class="title">« 上一页</span>
    <br>
    <span>ELK和EFK</span>
  </a>
  <a class="next" href="https://gopherding.github.io/posts/read/%E8%AE%BA%E8%BE%A9%E7%9A%84%E9%AD%82%E7%81%B5/">
    <span class="title">下一页 »</span>
    <br>
    <span>论辩的魂灵</span>
  </a>
</nav>

        </footer>
    </div>

<style>
    .comments_details summary::marker {
        font-size: 20px;
        content: '👉展开评论';
        color: var(--content);
    }
    .comments_details[open] summary::marker{
        font-size: 20px;
        content: '👇关闭评论';
        color: var(--content);
    }
</style>


<div>
    <details class="comments_details">
        <summary style="cursor: pointer; margin: 50px 0 20px 0;width: 130px;">
            <span style="font-size: 20px;color: var(--content);">...</span>
        </summary>
        <div id="tcomment"></div>
    </details>
    <script src="https://cdn.staticfile.org/twikoo//twikoo.all.min.js">
    </script>
    <script>
        twikoo.init({
            envId:  null ,
        el: "#tcomment",
            lang: 'zh-CN',
            region:  null ,
        path: window.TWIKOO_MAGIC_PATH||window.location.pathname,
        })
    </script>
</div>
</article>
</main>

<footer class="footer">
    <span>
        Copyright
        &copy;
        2021-2025
        <a href="https://gopherding.github.io/" style="color:#939393;">GopherDing&#39;s Blog</a>
        All Rights Reserved. Generated with 
        <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a>
        .Version 0.147.9.
    </span>
    <a href="https://beian.miit.gov.cn/" target="_blank" style="color:#939393;"></a>&nbsp;
    <span>
        <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=null"
           style="display:inline-block;text-decoration:none;height:20px;color:#939393;">
            <img src="" style="float:left;margin: 0px 5px 0px 0px;"/>
            
        </a>
    </span>
    <br>
    <span id="busuanzi_container">
        <span class="fa fa-user"></span> <span id="busuanzi_value_site_uv"></span>
        <span class="fa fa-eye"></span> <span id="busuanzi_value_site_pv"></span>
    </span>
</footer>




  <script src="/js/typewriter.js"></script>

<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <span class="topInner">
        <svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
            <path d="M12 6H0l6-6z"/>
        </svg>
        <span id="read_progress"></span>
    </span>
</a>

<script>
    document.addEventListener('scroll', function (e) {
        const readProgress = document.getElementById("read_progress");
        const scrollHeight = document.documentElement.scrollHeight;
        const clientHeight = document.documentElement.clientHeight;
        const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
        readProgress.innerText = ((scrollTop / (scrollHeight - clientHeight)).toFixed(2) * 100).toFixed(0);
    })
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });
</script>
<script>
    let mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };
</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        (function() {
            document.cookie = "change-themes" + "="+ escape ("false");
        })()

        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    });
</script>

<script>
    document.body.addEventListener('copy', function (e) {
        if (window.getSelection().toString() && window.getSelection().toString().length > 50) {
            let clipboardData = e.clipboardData || window.clipboardData;
            if (clipboardData) {
                e.preventDefault();
                let htmlData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"GopherDing's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                let textData = window.getSelection().toString() +
                    '\r\n\n————————————————\r\n' +
                    '版权声明：本文为「'+"GopherDing's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                clipboardData.setData('text/html', htmlData);
                clipboardData.setData('text/plain', textData);
            }
        }
    });
</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;
        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = '复制';

        function copyingDone() {
            copybutton.innerText = '已复制！';
            setTimeout(() => {
                copybutton.innerText = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                let text = codeblock.textContent +
                    '\r\n————————————————\r\n' +
                    '版权声明：本文为「'+"GopherDing's Blog"+'」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。' +
                '\r\n原文链接：' + location.href;
                navigator.clipboard.writeText(text);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) {}
            selection.removeRange(range);
        });

        let language = codeblock.className.replaceAll("language-", "")
        let macTool = document.createElement("div")
        let macTool1 = document.createElement("div")
        let macTool2 = document.createElement("div")
        let macTool3 = document.createElement("div")
        let languageType = document.createElement("div")
        languageType.innerText = language
        macTool.setAttribute('class', 'mac-tool')
        macTool1.setAttribute('class', 'mac bb1')
        macTool2.setAttribute('class', 'mac bb2')
        macTool3.setAttribute('class', 'mac bb3')
        languageType.setAttribute('class', 'language-type')
        macTool.appendChild(macTool1)
        macTool.appendChild(macTool2)
        macTool.appendChild(macTool3)
        macTool.appendChild(languageType)

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
            container.appendChild(macTool)
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
            container.appendChild(macTool)
        }
    });
</script>
</body>

</html>
